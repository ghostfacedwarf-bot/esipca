// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Admin User
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String?
  role      String     @default("admin")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// Product Category
model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  image       String?
  parentId    String?    // For subcategories
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  products    Product[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Main Product
model Product {
  id                   String     @id @default(cuid())
  name                 String
  slug                 String     @unique
  shortDescription    String?
  longDescription     String?
  categoryId          String
  category            Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // Pricing
  priceFrom           Float      // Starting price
  priceType           String     @default("per_piece") // per_piece or per_meter

  // Specifications as JSON
  specs               Json?      // {material: "...", thickness: "...", colors: [...]}

  // Status
  isFeatured          Boolean    @default(false)
  isBestseller        Boolean    @default(false)
  isActive            Boolean    @default(true)

  // Relations
  variants            Variant[]
  media               Media[]
  cartItems           CartItem[]
  orderItems          OrderItem[]
  reviews             Review[]

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
}

// Product Variant (color, thickness, length combo)
model Variant {
  id          String     @id @default(cuid())
  productId   String
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku         String     @unique
  // Variant attributes: color, thickness, length, finish, etc.
  attributes  Json       // {color: "red", thickness: "0.5mm", length: "1m", finish: "matte"}

  price       Float      // Price for Romania
  priceEU     Float?     // Price for EU (null = use price)
  stockStatus String     @default("in_stock") // in_stock, preorder, out_of_stock
  stockQty    Int        @default(9999)

  cartItems   CartItem[]
  orderItems  OrderItem[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Product Media
model Media {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String
  alt       String?
  sortOrder Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Shopping Cart (session-based)
model CartItem {
  id        String   @id @default(cuid())
  sessionId String   // Browser session ID
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  variantId String
  variant   Variant  @relation(fields: [variantId], references: [id], onDelete: Cascade)

  quantity  Int      @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, productId, variantId])
}

// Order
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique @default(cuid())

  // Customer
  customerName    String
  customerEmail   String
  customerPhone   String
  customerAddress String?
  customerCity    String?
  customerCounty  String?
  customerPostal  String?

  // Items
  items           OrderItem[]

  // Metadata
  message         String?     // Special requests
  estimatedTotal  Float?      // Rough total for reference
  status          String      @default("pending") // pending, confirmed, shipped, completed, cancelled
  paymentMethod   String      @default("email_request") // email_request, whatsapp

  notes           String?     // Internal notes

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// Order Item
model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id])

  variantId String
  variant   Variant  @relation(fields: [variantId], references: [id])

  quantity  Int
  price     Float    // Price at time of order

  createdAt DateTime @default(now())
}

// Review (optional)
model Review {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  name      String
  email     String?
  rating    Int      @default(5)
  text      String?
  isApproved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Settings
model Settings {
  id                  String   @id @default("default")
  companyName         String   @default("Esipca Metalica")
  companyAddress      String   @default("Galati, DN26 Nr 19")
  companyPhone        String   @default("+40 (722) 292 519")
  companyEmail        String   @default("office@exprestrading.com")
  freeShippingThreshold Float  @default(350)
  warrantyYears       Int      @default(30)
  deliveryDays        String   @default("1-7")
  updatedAt           DateTime @updatedAt
}
